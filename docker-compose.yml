services:
  celestia-init:
    image: ghcr.io/celestiaorg/celestia-app-standalone:feature-zk-execution-ism
    container_name: celestia-init
    entrypoint: /scripts/init.sh
    volumes:
      - ./testnet/celestia-app/init.sh:/scripts/init.sh:ro
      - celestia-app:/home/celestia/.celestia-app
    restart: "no"

  celestia-validator:
    image: ghcr.io/celestiaorg/celestia-app-standalone:feature-zk-execution-ism
    container_name: celestia-validator
    ports:
      - "26656:26656"
      - "26657:26657"
      - "9090:9090"
    healthcheck:
      test: [
        "CMD-SHELL",
        "bh=$(curl -sf http://localhost:26657/status | jq -r '.result.sync_info.latest_block_height'); if [ \"$$bh\" -gt 1 ]; then exit 0; else exit 1; fi"
      ]
      interval: 30s
      timeout: 5s
      start_period: 10s
    volumes:
      - celestia-app:/home/celestia/.celestia-app
    command: >
      start --force-no-bbr
    depends_on:
      celestia-init:
        condition: service_completed_successfully
    networks:
      - celestia-zkevm-net

  celestia-bridge:
    image: ghcr.io/celestiaorg/celestia-node:v0.23.0-rc0
    container_name: celestia-bridge
    volumes:
      - ./testnet/celestia-node/init.sh:/scripts/init.sh:ro
      - celestia-bridge:/home/celestia
    entrypoint: /scripts/init.sh
    command: celestia bridge start --log.level.module share/discovery:fatal --keyring.keyname node --rpc.skip-auth
    ports:
      - "26658:26658"
      - "2121:2121"
    healthcheck:
      test: >
        curl -sf -X POST http://localhost:26658
        -H "Content-Type: application/json"
        -d '{"id":1,"jsonrpc":"2.0","method":"node.Ready","params":[]}' | grep true
      interval: 10s
      start_period: 10s
    depends_on:
      celestia-validator:
        condition: service_healthy
    networks:
      - celestia-zkevm-net

  rollkit-evm-single:
    image: ghcr.io/rollkit/rollkit-evm-single:v0.1.3
    container_name: rollkit-evm-single
    entrypoint: /usr/bin/entrypoint.sh
    environment:
      - EVM_ENGINE_URL=http://reth:8551
      - EVM_ETH_URL=http://reth:8545
      - EVM_JWT_SECRET=f747494bb0fb338a0d71f5f9fe5b5034c17cc988c229b59fd71e005ee692e9bf
      - EVM_GENESIS_HASH=0x06bab65f0fa3c9b1ba0da34e319d7a5cd948cd10ba33080b88f17d281880e344
      - EVM_BLOCK_TIME=1s
      - EVM_SIGNER_PASSPHRASE=secret
      - DA_ADDRESS=http://celestia-bridge:26658
      - DA_AUTH_TOKEN=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBbGxvdyI6WyJwdWJsaWMiLCJyZWFkIiwid3JpdGUiLCJhZG1pbiJdfQ.qxoN_a-k7aZZE77VSpfgyvI_0eNvJ_OgBsT35zxUQnQ
      - DA_NAMESPACE=00000000000000000000000000000000000000b7b24d9321578eb83626
    depends_on:
      celestia-bridge:
        condition: service_healthy
      reth:
        condition: service_started
    networks:
      - celestia-zkevm-net
  
  reth:
    image: ghcr.io/paradigmxyz/reth:v1.3.11
    container_name: reth
    ports:
      - "9001:9001"   # Metrics
      - "30303:30303" # P2P
      - "8545:8545"   # HTTP
      - "8551:8551"   # Auth RPC (Engine API)
    volumes:
      - ./testnet/reth:/home/reth
      - reth:/home/reth/eth-home
    entrypoint: /bin/sh -c
    command:
      - |
          reth node \
          --chain /home/reth/eth-genesis.json \
          --metrics 0.0.0.0:9001 \
          --authrpc.addr 0.0.0.0 \
          --authrpc.port 8551 \
          --http \
          --http.addr 0.0.0.0 \
          --http.port 8545 \
          --http.api "eth,net,web3,txpool" \
          --authrpc.jwtsecret /home/reth/jwt.hex \
          --datadir /home/reth/eth-home \
          --ipcpath /home/reth/eth-home/eth-engine.ipc \
          --disable-discovery \
          --rpc.eth-proof-window 120000
    networks:
      - celestia-zkevm-net

  hyperlane-init:
    image: ghcr.io/celestiaorg/hyperlane-init:latest
    container_name: hyperlane-init
    volumes:
      - hyperlane:/home/hyperlane/
    entrypoint: "scripts/docker-entrypoint.sh"
    depends_on:
      celestia-validator:
        condition: service_healthy
      reth:
        condition: service_started
    restart: "no"
    networks:
      - celestia-zkevm-net

  # TODO: Determine why this does not work but running a relayer binary locally built from main
  # can relay a successful warp transfer.
  # relayer:
  #   image: gcr.io/abacus-labs-dev/hyperlane-agent:agents-v1.4.0
  #   container_name: relayer
  #   environment:
  #     - CONFIG_FILES=/app/config/config.json
  #   volumes:
  #     - ./hyperlane/relayer-config.json:/app/config/config.json
  #   command: "/app/relayer"
  #   depends_on:
  #     hyperlane-init:
  #       condition: service_completed_successfully
  #   networks:
  #     - celestia-zkevm-net

volumes:
  celestia-app:
  celestia-bridge:
  hyperlane:
  reth:

networks:
  celestia-zkevm-net:
    driver: bridge